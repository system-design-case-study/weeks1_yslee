# Feature Specification: k6 부하 테스트 + Prometheus/Grafana 시각화

**Feature Branch**: `005-k6-load-test-visualization`
**Created**: 2026-02-09
**Status**: Draft
**Input**: User description: "k6, 그라파나, 프로메테우스 추가해서 부하테스트와 테스트 시각화를 하고싶어"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - k6 부하 테스트 실행 (Priority: P1)

개발자가 Proximity Service API에 대해 실제 HTTP 부하를 발생시켜, 다양한 시나리오(주변 검색, CRUD)의 응답 시간과 처리량을 측정한다. 터미널 명령 하나로 부하 테스트를 시작하고 결과를 확인할 수 있다.

**Why this priority**: 부하 테스트 실행이 불가능하면 시각화도 의미가 없다. k6 스크립트와 실행 환경이 모든 후속 기능의 기반이다.

**Independent Test**: k6 스크립트를 실행하여 API 응답 코드, 레이턴시, 처리량 수치가 터미널에 출력되는 것만으로 독립적 가치를 제공한다.

**Acceptance Scenarios**:

1. **Given** Proximity Service가 실행 중일 때, **When** 주변 검색 부하 테스트를 시작하면, **Then** 지정한 가상 사용자(VU) 수만큼 동시 요청이 발생하고 응답 시간/처리량이 터미널에 출력된다.
2. **Given** 부하 테스트 시나리오가 정의되어 있을 때, **When** CRUD 혼합 부하 테스트를 실행하면, **Then** 생성/조회/수정/삭제 API가 설정된 비율로 호출되고 각 엔드포인트별 결과가 구분되어 출력된다.
3. **Given** 부하 테스트가 실행 중일 때, **When** 단계별로 가상 사용자 수가 증가하면(ramp-up), **Then** 각 단계별 성능 변화를 확인할 수 있다.
4. **Given** 부하 테스트가 완료되었을 때, **When** 결과를 확인하면, **Then** p50/p95/p99 레이턴시, 초당 요청 수(RPS), 에러율이 명확히 표시된다.

---

### User Story 2 - Prometheus 메트릭 수집 (Priority: P2)

부하 테스트 실행 중 발생하는 메트릭(응답 시간, 요청 수, 에러율)과 애플리케이션 내부 메트릭(JVM, 커넥션 풀, Redis 연결)이 자동으로 수집되어 시계열 데이터로 저장된다.

**Why this priority**: 시각화(Grafana)의 데이터 소스. 수집이 없으면 대시보드에 표시할 내용이 없다.

**Independent Test**: Prometheus 웹 UI에서 수집된 메트릭을 쿼리하여 데이터가 존재하는지 확인할 수 있다.

**Acceptance Scenarios**:

1. **Given** 애플리케이션이 실행 중일 때, **When** 메트릭 엔드포인트에 접근하면, **Then** HTTP 요청 수, 응답 시간 히스토그램, JVM 메트릭이 표준 형식으로 제공된다.
2. **Given** k6 부하 테스트가 실행 중일 때, **When** 메트릭 수집 시스템이 동작하면, **Then** 요청당 응답 시간, 에러 수, 동시 접속 수가 시계열로 저장된다.
3. **Given** 메트릭이 수집되고 있을 때, **When** 특정 시간 범위를 조회하면, **Then** 해당 기간의 레이턴시 분포(히스토그램), 요청율(카운터), 현재 연결 수(게이지) 등을 확인할 수 있다.

---

### User Story 3 - Grafana 대시보드 시각화 (Priority: P3)

수집된 메트릭을 실시간 대시보드에서 그래프/차트로 시각화한다. 부하 테스트 실행 중 브라우저에서 실시간으로 성능 변화를 관찰하고, 테스트 완료 후에도 결과를 시각적으로 분석할 수 있다.

**Why this priority**: 수집된 데이터를 사람이 이해하기 쉬운 형태로 보여주는 최종 단계. P1/P2가 완료되어야 의미가 있다.

**Independent Test**: 부하 테스트 실행 후 브라우저에서 대시보드를 열어 그래프가 데이터를 표시하는지 확인할 수 있다.

**Acceptance Scenarios**:

1. **Given** 메트릭 수집이 활성화된 상태에서, **When** 대시보드에 접근하면, **Then** 사전 구성된 패널들(레이턴시, RPS, 에러율, JVM 메트릭)이 표시된다.
2. **Given** 부하 테스트가 실행 중일 때, **When** 대시보드를 관찰하면, **Then** 실시간으로 그래프가 업데이트되어 성능 변화를 시각적으로 확인할 수 있다.
3. **Given** 부하 테스트가 완료된 후, **When** 대시보드에서 시간 범위를 테스트 기간으로 설정하면, **Then** 전체 테스트 동안의 성능 추이(ramp-up→steady→ramp-down)를 한눈에 볼 수 있다.

---

### User Story 4 - 원클릭 통합 실행 (Priority: P4)

개발자가 단일 명령어로 전체 인프라(서비스 + 데이터베이스 + 모니터링 스택)를 시작하고 부하 테스트를 실행할 수 있다. 별도의 수동 설정 없이 Docker Compose 한 번으로 모든 구성 요소가 연동된다.

**Why this priority**: 개발자 경험을 크게 향상시키지만, P1~P3이 각각 동작해야 통합이 가능하다.

**Independent Test**: `docker compose up` 한 번으로 모든 서비스가 시작되고, k6 실행 후 대시보드에서 결과를 확인할 수 있다.

**Acceptance Scenarios**:

1. **Given** Docker가 설치되어 있을 때, **When** 통합 실행 명령을 입력하면, **Then** 애플리케이션, 데이터베이스, 메트릭 수집기, 대시보드가 모두 시작된다.
2. **Given** 모든 서비스가 실행 중일 때, **When** 부하 테스트를 시작하면, **Then** 메트릭이 자동으로 수집되고 대시보드에 실시간 반영된다.
3. **Given** 테스트가 완료된 후, **When** 정리 명령을 실행하면, **Then** 모든 컨테이너와 네트워크가 정리된다.

---

### Edge Cases

- 부하 테스트 중 애플리케이션이 응답 불가 상태가 되면 어떻게 되는가? → k6는 타임아웃 에러로 기록하고 테스트를 계속 진행한다.
- 메트릭 수집기가 중단되면 부하 테스트에 영향이 있는가? → 없다. 메트릭 수집은 부하 테스트와 독립적이다.
- 대시보드에 데이터가 표시되지 않는 경우? → 메트릭 수집기와 데이터 소스 연결 상태를 확인하는 가이드를 제공한다.
- 매우 높은 부하(1000+ VU)에서 테스트 도구 자체가 병목이 되면? → 단일 머신 기준 최대 VU 권장치를 문서에 명시한다.

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: 시스템은 주변 검색 API(`GET /api/businesses/nearby`)에 대한 부하 테스트 시나리오를 제공해야 한다
- **FR-002**: 시스템은 CRUD API 전체(`POST/GET/PUT/DELETE /api/businesses`)에 대한 혼합 부하 테스트 시나리오를 제공해야 한다
- **FR-003**: 부하 테스트는 단계별 가상 사용자 증가/유지/감소(ramp-up, steady, ramp-down) 패턴을 지원해야 한다
- **FR-004**: 부하 테스트 완료 시 p50/p95/p99 레이턴시, RPS, 에러율을 포함한 요약을 출력해야 한다
- **FR-005**: 애플리케이션은 HTTP 요청 수, 응답 시간 히스토그램, 에러 수를 표준 메트릭 형식으로 노출해야 한다
- **FR-006**: 애플리케이션은 JVM 메트릭(힙 메모리, GC, 스레드)과 커넥션 풀 메트릭을 노출해야 한다
- **FR-007**: 메트릭 수집 시스템은 애플리케이션과 부하 테스트 도구 양쪽의 메트릭을 주기적으로 수집하여 시계열로 저장해야 한다
- **FR-008**: 시각화 대시보드는 최소 4개 패널(레이턴시 분포, RPS, 에러율, JVM 메트릭)을 사전 구성된 상태로 제공해야 한다
- **FR-009**: 대시보드는 부하 테스트 중 실시간으로(5초 이내 갱신) 메트릭을 표시해야 한다
- **FR-010**: 단일 명령어로 전체 인프라(애플리케이션 + DB + 모니터링 스택)를 시작할 수 있어야 한다
- **FR-011**: 부하 테스트 시나리오는 테스트 데이터 시딩(사전 등록)을 포함하여 독립적으로 실행 가능해야 한다

### Key Entities

- **부하 테스트 시나리오(Load Test Scenario)**: 테스트 대상 API, 가상 사용자 수, 실행 시간, 단계(stage) 정의. 시나리오별 성공 기준(threshold) 포함.
- **메트릭(Metric)**: 시계열 데이터. 유형별로 카운터(요청 수), 히스토그램(응답 시간 분포), 게이지(현재 연결 수)로 구분.
- **대시보드(Dashboard)**: 메트릭을 시각화하는 패널들의 집합. JSON 설정 파일로 정의되며 자동 프로비저닝.

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 주변 검색 API에 50 가상 사용자가 30초간 부하를 발생시켰을 때, p95 응답 시간이 500ms 이내이다
- **SC-002**: CRUD 혼합 부하 테스트에서 에러율이 1% 미만이다
- **SC-003**: 부하 테스트 실행 후 5초 이내에 대시보드에서 실시간 메트릭 그래프를 확인할 수 있다
- **SC-004**: `docker compose up` 단일 명령으로 전체 스택(앱 + DB + 모니터링)이 2분 이내에 시작된다
- **SC-005**: 대시보드에서 부하 테스트 전체 기간의 레이턴시 추이, RPS 변화, 에러율을 한눈에 확인할 수 있다
- **SC-006**: 부하 테스트 재실행 시 이전 실행과 동일한 조건에서 결과를 비교할 수 있다

## Assumptions & Constraints

- Phase 1~4까지 구현 완료된 Proximity Service API가 동작하는 상태에서 진행
- 프로덕션 코드 변경은 메트릭 노출 엔드포인트 추가에 한정 (비즈니스 로직 변경 없음)
- 모든 인프라는 Docker Compose 기반으로 로컬에서 실행 (클라우드 배포 없음)
- 단일 머신 기준 부하 테스트 (분산 부하 테스트는 범위 외)
- 부하 테스트 데이터는 테스트 시작 시 자동 시딩하고 종료 후 정리하지 않아도 됨 (컨테이너 기반)
- Grafana 대시보드는 익명 접근 가능 (로컬 개발 환경이므로 인증 불필요)
